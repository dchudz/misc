```{r libs,error=FALSE, warning=FALSE, results='hide', message=FALSE, echo=FALSE}
require(plyr)
require(ggplot2)
library(rstan)
library(reshape2)
setwd(Sys.getenv("GITHUB_PATH"))
setwd("./misc/stan models/increasing by chi square increments/")
source("data generation function.R")
source("chi_square_jumps_hierarchical.R")
```


## Samples from uniform prior 

uniform conditional on increasing is the same as uniform, then sort.
why?

$$p(\mu_k=x | \mu_1 < \mu_2 < ... < \mu_N )$$

is proportional to the probability that the first $k-1$ $\mu_i$'s are less than $x$ and the last $n-k$ $\mu_i$'s are greater than $x$. 

If instead we get $\mu_i$'s by drawing each from i.i.d. uniform and sorting, then 

$$p(\mu_k=x)$$

is proportional the probability that $k-1$ $\mu_i$'s are less than $x$ and exactly $n-k$ $\mu_i$'s are greater than $x$. 

(concentrate on straight line)

```{r sample_from_restricted_uniform, cache=TRUE,error=FALSE, warning=FALSE, results='hide', message=FALSE, echo=FALSE}

plot(sort(runif(100)))
plot(sort(runif(1000)))

```
  


## Setting up the prior

Here are samples from the prior. First showing everything, and then zoomed in a bit.

```{r samples_from_mU_prior,error=FALSE, warning=FALSE, results='hide', message=FALSE, echo=FALSE}
set.seed(38738)
samples <- ldply(1:20, function(x) {
  fake_data <- generate_data_including_hyperparameters(50)
  fake_data$sample_number <- x
  fake_data
})
samples
ggplot() + geom_line(data=samples, mapping=aes(x=t,y=mu, color="mu", group=sample_number)) 
```

## Fitting the model

```{r fit_model, fig.show='hide', cache=TRUE,error=FALSE, warning=FALSE, results='hide', message=FALSE, echo=FALSE}
set.seed(1)
fits1 <- generate_data_and_fit_both_models(50,10)
```

Plot the data with the model fit:

```{r display_fit, dependson="fit_model",error=FALSE, warning=FALSE, results='hide', message=FALSE, echo=FALSE}
print(fits1$plot + ggtitle("data and model, aggregated and not"))
```

I think the hyperparameters are mostly shrinkages from prior to toward truth?

Aggregates and not are not too terribly different

```{r posterior_hyperparameters, dependson="fit_model",error=FALSE, warning=FALSE, results='hide', message=FALSE, echo=FALSE}
plot_posteriors_both_models(fits1, "mean_mu_N")
plot_posteriors_both_models(fits1, "sigma_mu_N")
plot_posteriors_both_models(fits1, "sigma_0")
```

Plot samples:

```{r plot_posterior_sample_mus, dependson="fit_model",error=FALSE, warning=FALSE, results='hide', message=FALSE, echo=FALSE}
set.seed(7373)
plot_samples(fits1, 20)
```